#!/usr/bin/env bash

set -euo pipefail

echo "Stopping etcd"
/var/vcap/bosh/bin/monit stop etcd

output="$(/var/vcap/bosh/bin/monit summary | grep 'etcd')"
timeout=0

while [[ $output != *"not monitored" ]]
do
  if [ $timeout == 60 ]; then echo "Timed out stopping etcd"; exit 1; fi
  timeout=$((timeout + 1))

  echo "waiting"
  sleep 1

  output="$(/var/vcap/bosh/bin/monit summary | grep 'etcd')"
done

echo "Etcd stopped"

echo "Deleting old etcd data"
rm -rf /var/vcap/store/etcd