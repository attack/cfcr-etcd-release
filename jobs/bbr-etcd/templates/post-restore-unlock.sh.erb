#!/usr/bin/env bash

set -euo pipefail

echo "Starting etcd"

/var/vcap/bosh/bin/monit start etcd

ensure_etcd_running() {
  until "$(/var/vcap/bosh/bin/monit summary | grep etcd)" == *"running"*; do
    sleep 1
  done
}

TIMEOUT=60

if timeout "$TIMEOUT" ensure_etcd_running
then
  echo "Etcd has been started and is running"
else
  echo "Timed out starting etcd after $TIMEOUT seconds"
  exit 1
fi
