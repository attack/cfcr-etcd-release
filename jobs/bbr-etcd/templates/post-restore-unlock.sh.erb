#!/usr/bin/env bash

set -euo pipefail

echo "Starting etcd"

/var/vcap/bosh/bin/monit start etcd

TIMEOUT=60

if timeout "$TIMEOUT" /bin/bash <<EOF
  #!/bin/bash

  until /var/vcap/bosh/bin/monit summary | grep etcd | grep running ; do
    echo "waiting for etcd to start..."
    sleep 5
  done
EOF
then
  echo "Etcd has been started and is running"
else
  echo "Timed out starting etcd after $TIMEOUT seconds"
  exit 1
fi
