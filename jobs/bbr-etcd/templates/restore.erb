#!/bin/bash

set -euo pipefail

function ping_bootstrap_etcd {
 curl --silent https://master-0.etcd.cfcr.internal:2379/health --cacert /var/vcap/jobs/etcd/config/etcdctl-ca.crt --cert /var/vcap/jobs/etcd/config/etcdctl.crt --key /var/vcap/jobs/etcd/config/etcdctl.key
}

<% if spec.bootstrap %>
source /var/vcap/jobs/etcd/bin/utils.sh

exec 1>&2

export BBR_ARTIFACT_FILE_PATH="${BBR_ARTIFACT_DIRECTORY}/snapshotdb"
export ETCDCTL_API=3

echo "Restoring etcd data"
/var/vcap/packages/etcd/bin/etcdctl \
    snapshot restore ${BBR_ARTIFACT_FILE_PATH} \
    --name="<%= spec.id %>" \
    --initial-cluster="${etcd_peers}" \
    --initial-advertise-peer-urls="${etcd_peer_address}" \
    --data-dir="/var/vcap/store/etcd"

chown -R vcap:vcap /var/vcap/store/etcd

<% else %>
# MASTER 1 | 2
# Wait here till bootstrap is restored
# -> ETCD has been brought down in pre_restore_lock
# -> rm /var/vcap/store/etcd
# -> wait till bootstrap etcd process has started.

until ping_bootstrap_etcd
do
    echo "Waiting for etcd bootstrap node to come up"
    sleep 1
done

# -> start local ETCD
#
<% end %>

echo "Starting etcd"
/var/vcap/jobs/bpm/bin/bpm start etcd
/var/vcap/bosh/bin/monit summary
/var/vcap/bosh/bin/monit monitor etcd
